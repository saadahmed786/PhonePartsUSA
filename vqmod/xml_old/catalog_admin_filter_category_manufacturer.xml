<modification>
	<id>Admin Catalog - Added Category AND Manufacturer Filter</id>
	<version>1.5.x</version>
	<vqmver>1.0.9</vqmver>
	<author>santha.opencart@gmail.com</author>
	<file name="admin/controller/catalog/product.php">		
		<operation error="skip">
			<search position="after"><![CDATA[
			$this->data['column_model'] = $this->language->get('column_model');
			]]></search>
			<add><![CDATA[
			$this->data['column_category'] = $this->language->get('column_category');
			$this->data['column_manufacturer'] = $this->language->get('column_manufacturer');
			]]></add>
		</operation>		
		<operation error="skip">
			<search position="before" index="5,10"><![CDATA[
			if (isset($this->request->get['filter_model'])) {
			]]></search>
			<add><![CDATA[			
			if (isset($this->request->get['filter_category_id'])) {
				$filter_category_id = $this->request->get['filter_category_id'];
			} else {
				$filter_category_id = null;
			}
			if (isset($this->request->get['filter_manufacturer'])) {
				$filter_manufacturer = $this->request->get['filter_manufacturer'];
			} else {
				$filter_manufacturer = null;
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before" index="1,2,3,4,6,7,8,10"><![CDATA[
			if (isset($this->request->get['filter_model'])) {
			]]></search>
			<add><![CDATA[
			if (isset($this->request->get['filter_manufacturer'])) {
				$url .= '&filter_manufacturer=' . $this->request->get['filter_manufacturer'];
			}
			if (isset($this->request->get['filter_category_id'])) {
				$url .= '&filter_category_id=' . $this->request->get['filter_category_id'] . '&filter_sub_category=true';
			}
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			$this->data['sort_model'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.model' . $url, 'SSL');
			]]></search>
			<add><![CDATA[
			$this->data['sort_manufacturer'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.manufacturer' . $url, 'SSL');
			$this->data['sort_category'] = $this->url->link('catalog/product', 'token=' . $this->session->data['token'] . '&sort=p.category' . $url, 'SSL');						
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			'filter_model'	  => $filter_model,
			]]></search>
			<add><![CDATA[			
			'filter_category_id'	  => $filter_category_id,
			'filter_manufacturer'	  => $filter_manufacturer,
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			$this->data['filter_model'] = $filter_model;
			]]></search>
			<add><![CDATA[
			$this->data['filter_category_id'] = $filter_category_id;
			$this->data['filter_manufacturer'] = $filter_manufacturer;
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			private function getList() {
			]]></search>
			<add><![CDATA[
			$this->load->model('catalog/category');	
			$this->load->model('catalog/manufacturer');			
			$this->data['categories'] = $this->model_catalog_category->getCategories(0);
			$m_sort = array( 'sort' => 'name', 'order' => 'ASC');
			$this->data['manufacturers'] = $this->model_catalog_manufacturer->getManufacturers( $m_sort );
			]]></add>
		</operation>	
		<operation error="skip">
			<search position="before"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			$category = $this->model_catalog_product->getProductCategoriesInfo( $result['product_id'] );		
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
			$this->data['products'][] = array(
			]]></search>
			<add><![CDATA[
			'category' => $category,
			'manufacturer' => $result['manufacturer'],	
			]]></add>
		</operation>								
	</file>	
	<file name="admin/model/catalog/product.php">
		<operation error="skip">
			<search position="replace"><![CDATA[
			$sql = "SELECT * FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id)";
			]]></search>
			<add><![CDATA[
			$sql = "SELECT p.*,pd.*, m.name as manufacturer FROM " . DB_PREFIX . "product p LEFT JOIN " . DB_PREFIX . "product_description pd ON (p.product_id = pd.product_id) LEFT JOIN " . DB_PREFIX . "manufacturer m ON ( p.manufacturer_id = m.manufacturer_id )";
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			$sql .= " GROUP BY p.product_id";
			]]></search>
			<add><![CDATA[
			if (isset($data['filter_manufacturer']) && !is_null($data['filter_manufacturer'])) {
				$sql .= " AND p.manufacturer_id = '" . (int)$data['filter_manufacturer'] . "'";
			}	
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
			public function getProductCategories($product_id) {
			]]></search>
			<add><![CDATA[			
			public function getProductCategoriesInfo($product_id) {			
			$product_category_data = array();
					
			$query = $this->db->query("SELECT c.*, cd.name FROM " . DB_PREFIX . "product_to_category c INNER JOIN " . DB_PREFIX . "category_description cd ON c.category_id = cd.category_id WHERE product_id = '" . (int)$product_id . "'");
		
			foreach ($query->rows as $result) {	
				$path = $this->model_catalog_category->getPath( $result['category_id'] );			
				$product_category_data[] = array( 
				'id' => $result['category_id'], 
				'name' => $result['name'],
				'path' => $path
				);
			}			
			return $product_category_data;
			}
			]]></add>
		</operation>		
	</file>	
	<file name="admin/language/english/catalog/product.php">	
		<operation error="skip">
			<search position="after"><![CDATA[
			$_['column_model']           = 'Model';
			]]></search>
			<add><![CDATA[
			$_['column_category']           = 'Category';
			$_['column_manufacturer']           = 'Manufacturer';
			]]></add>
		</operation>
	</file>
	<file name="admin/view/template/catalog/product_list.tpl">
		
		
		
		<operation error="skip">
			<search position="before"><![CDATA[
			if (filter_price) {
			]]></search>
			<add><![CDATA[
			var filter_category = $('select[name=\'filter_category\']').val();
			var filter_manufacturer = $('select[name=\'filter_manufacturer\']').val();
			if (filter_manufacturer && parseInt( filter_manufacturer, 10 ) > 0 ) {
				url += '&filter_manufacturer=' + encodeURIComponent(filter_manufacturer);
			}	
			if (filter_category && parseInt( filter_category, 10 ) > 0 ) {
				url += '&filter_category_id=' + encodeURIComponent(filter_category) + '&filter_sub_category=true';
			}
			]]></add>
		</operation>
	</file>
</modification>
