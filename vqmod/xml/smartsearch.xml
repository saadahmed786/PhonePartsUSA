<modification>
	
	<id>Smart Search</id>
	<version>154.2</version>
	<vqmver>2.1.7</vqmver>
	<author>Clear Thinking, LLC</author>
	<email>johnathan@getclearthinking.com</email>
	<website>http://www.getclearthinking.com</website>
	
	<file name="admin/view/template/common/header.tpl" error="skip">
		<operation error="skip">
			<search position="after" offset="1"><![CDATA[
				<li id="reports"><a class="top"><?php echo $text_reports; ?></a>
			]]></search>
			<add trim="true"><![CDATA[
				<li><a href="<?php echo HTTPS_SERVER . 'index.php?route=report/smartsearch&token=' . $this->session->data['token']; ?>">Smart Search History</a></li>
			]]></add>
		</operation>
	</file>
	
	<!-- Regular Search -->
	<file name="catalog/controller/product/search.php" error="skip">
		<!-- All Versions -->
		<operation error="skip">
			<search position="before"><![CDATA[
				_total =
			]]></search>
			<add trim="true"><![CDATA[
				// Clear Thinking: Smart Search
				if (!$this->config->get('smartsearch_status')) {
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				_total =
			]]></search>
			<add trim="true"><![CDATA[
				}
				// end Smart Search
			]]></add>
		</operation>
		<operation error="skip">
			<search position="before"><![CDATA[
				results = $this->model_catalog_product
			]]></search>
			<add trim="true"><![CDATA[
				// Clear Thinking: Smart Search
				if (!$this->config->get('smartsearch_status')) {
			]]></add>
		</operation>
		<operation error="skip">
			<search position="after"><![CDATA[
				results = $this->model_catalog_product
			]]></search>
			<add trim="true"><![CDATA[
				}
				// end Smart Search
			]]></add>
		</operation>
		
		<!-- v1.5.x -->
		<operation error="skip">
			<search position="after" offset="2"><![CDATA[
				'limit'               => $limit
			]]></search>
			<add trim="true"><![CDATA[
				// Clear Thinking: Smart Search
				if ($this->config->get('smartsearch_status')) {
					$this->load->model('catalog/smartsearch');
					
					$data['return_total'] = true;
					$product_total = $this->model_catalog_smartsearch->smartsearch($data);
					
					$data['return_total'] = false;
					$results = $this->model_catalog_smartsearch->smartsearch($data);
				}
				// end Smart Search
			]]></add>
		</operation>
		
		<!-- v1.4.x -->
		<operation error="skip">
			<search position="before"><![CDATA[
				if ($product_total) {
			]]></search>
			<add trim="true"><![CDATA[
				// Clear Thinking: Smart Search
				if ($this->config->get('smartsearch_status')) {
					$this->load->model('catalog/smartsearch');
					
					$limit = ($this->config->get('config_catalog_limit')) ? $this->config->get('config_catalog_limit') : 12;
					$data = array(
						'filter_name'			=> $this->data['keyword'],
						'filter_description'	=> $this->data['description'],
						'filter_model'			=> (isset($this->data['model'])) ? $this->data['model'] : $this->config->get('smartsearch_models'),
						'filter_category_id'	=> (isset($this->data['category_id'])) ? $this->data['category_id'] : 0,
						'sort'					=> $sort,
						'order'					=> $order,
						'start'					=> ($page - 1) * $limit,
						'limit'					=> $limit
					);
					
					$data['return_total'] = true;
					$product_total = $this->model_catalog_smartsearch->smartsearch($data);
					
					$data['return_total'] = false;
					$results = $this->model_catalog_smartsearch->smartsearch($data);
				}
				// end Smart Search
			]]></add>
		</operation>
	</file>
	
	<!-- AJAX Search -->
	<file name="catalog/view/theme/*/template/common/header.tpl" error="skip">
		<operation error="skip">
			<search position="before"><![CDATA[
				</head>
			]]></search>
			<add trim="true"><![CDATA[
				<?php $v14x = (!defined('VERSION') || VERSION < 1.5); ?>
				<?php $settings = ($v14x || strpos(VERSION, '1.5.0') === 0) ? unserialize($this->config->get('smartsearch_data')) : $this->config->get('smartsearch_data'); ?>
				<?php if ($settings['ajax_search']) { ?>
					<?php $selector = html_entity_decode($settings['ajax_selector'], ENT_QUOTES, 'UTF-8'); ?>
					<style type="text/css">
						#smartsearch {
							display: none;
							background: <?php echo $settings['ajax_background_color']; ?> !important;
							border: 1px solid <?php echo $settings['ajax_borders_color']; ?> !important;
							border-top: none !important;
							border-radius: 0 0 7px 7px !important;
							box-shadow: 0 2px 2px #DDD !important;
							margin: -3px 0 0 2px !important;
							padding: 0 !important;
							position: absolute !important;
							width: <?php echo $settings['ajax_width']; ?>px !important;
							z-index: 999999 !important;
						}
						.smartsearch-product {
							border-bottom: 1px solid <?php echo $settings['ajax_borders_color']; ?> !important;
							color: <?php echo $settings['ajax_font_color']; ?> !important;
							display: block !important;
							font-size: <?php echo $settings['ajax_description_font']; ?>px !important;
							font-weight: normal !important;
							<?php if ($settings['ajax_image_height']) { ?>
								min-height: <?php echo $settings['ajax_image_height']; ?>px !important;
							<?php } ?>
							padding: 5px !important;
							text-decoration: none !important;
						}
						.smartsearch-product:hover {
							background: <?php echo $settings['ajax_highlight_color']; ?> !important;
							text-decoration: none !important;
						}
						.smartsearch-product img {
							float: left !important;
							margin: 0 10px 0 0 !important;
						}
						.smartsearch-product strong {
							font-size: <?php echo $settings['ajax_product_font']; ?>px !important;
							margin: 5px 5px 5px 0 !important;
						}
						.smartsearch-bottom {
							font-weight: bold !important;
							padding: 10px !important;
							text-align: center !important;
						}
						<?php if ($v14x) { ?>
						.smartsearch-bottom a {
							color: <?php echo $settings['ajax_font_color']; ?> !important;
						}
						<?php } ?>
					</style>
					<script type="text/javascript">
						/* <![CDATA[ */
						var wait;
						
						$(document).ready(function(){
							$('<?php echo $selector; ?>').after('<div id="smartsearch"></div>').blur(function(){
								clearTimeout(wait);
								wait = setTimeout(hideSmartSearch, <?php echo $settings['ajax_delay']; ?>);
							}).keyup(function(e){
								if ($('<?php echo $selector; ?>').val().trim() && (e.which == 8 || (47 < e.which && e.which < 112) || e.which > 185)) {
									clearTimeout(wait);
									wait = setTimeout(showSmartSearch, <?php echo $settings['ajax_delay']; ?>);
								}
							});
						});
						
						function showSmartSearch() {
							$('#smartsearch').html('<div class="smartsearch-bottom"><img src="catalog/view/theme/default/image/loading<?php if ($v14x) echo '_1'; ?>.gif" /></div>').show();
							$.ajax({
								type: 'POST',
								url: 'index.php?route=module/smartsearch/smartsearch',
								data: {filter_name: $('<?php echo $selector; ?>').val()},
								dataType: 'json',
								success: function(data) {
									var html = '';
									if (data.length) {
										for (i = 0; i < data.length; i++) {
											html += '<a class="smartsearch-product" href="' + data[i]['href'] + '&<?php echo ($v14x) ? 'keyword' : 'filter_name'; ?>=' + encodeURIComponent($('<?php echo $selector; ?>').val()) + '">';
											<?php if ($settings['ajax_image_width']) { ?>
												html += '<img src="' + data[i]['image'] + '" />';
											<?php } ?>
											html += '<strong>' + data[i]['name'];
											<?php if ($settings['ajax_model']) { ?>
												html += ' (' + data[i]['model'] + ')';
											<?php } ?>
											<?php if ($settings['ajax_price']) { ?>
												var price = '<span style="color: <?php echo $settings['ajax_price_color']; ?>;' + (data[i]['special'] ? 'text-decoration: line-through' : '') + '">' + data[i]['price'] + '</span>';
												var special = (data[i]['special'] ? '<span style="color: <?php echo $settings['ajax_special_color']; ?>">' + data[i]['special'] + '</span>' : '');
												html += '<span style="float: right">' + price + ' ' + special + '</span>';
											<?php } ?>
											html += '</strong><br />';
											<?php if ($settings['ajax_description']) { ?>
												html += data[i]['description'];
											<?php } ?>
											html += '</a>';
										}
										<?php if ($settings['ajax_viewall'][$this->session->data['language']]) { ?>
											html += '<div class="smartsearch-bottom"><a href="<?php echo HTTP_SERVER; ?>index.php?route=product/search&<?php echo ($v14x) ? 'keyword' : 'filter_name'; ?>=' + encodeURIComponent($('<?php echo $selector; ?>').val()) + '"><?php echo html_entity_decode($settings['ajax_viewall'][$this->session->data['language']], ENT_QUOTES, 'UTF-8'); ?></a></div>';
										<?php } ?>
									} else {
										html = '<div class="smartsearch-bottom"><?php echo html_entity_decode($settings['ajax_noresults'][$this->session->data['language']], ENT_QUOTES, 'UTF-8'); ?></div>';
									}
									$('#smartsearch').html(html);
								}
							});
						}
						
						function hideSmartSearch() {
							$('#smartsearch').hide();
						}
						/* ]]]]><![CDATA[> */
					</script>
				<?php } ?>
			]]></add>
		</operation>
	</file>
	
</modification>