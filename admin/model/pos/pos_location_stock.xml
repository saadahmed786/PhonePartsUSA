<modification>
    <id>POS Location Based Stock Control</id>
    <version>1.0</version>
    <vqmver>2.x</vqmver>
    <author>Jimmy: flyingmel.java@gmail.com, Jason: hh4cimm@yahoo.com</author>
    <file name="admin/view/template/user/user_form.tpl">
		<operation>
			<search position="before" offset="1"><![CDATA[<td><span class="required">*</span> <?php echo $entry_firstname; ?></td>]]></search>
			<add><![CDATA[<tr>
				<td><span class="required">*</span> <?php echo $entry_location; ?></td>
				<td><select name="location_id">
				<?php if (!empty($locations)) {
					foreach ($locations as $location) {
						if ($location['location_id'] == $location_id) { ?>
							<option value="<?php echo $location['location_id']; ?>" selected="selected"><?php echo $location['name']. ' (' . $location['code'] . ')'; ?></option>
						<?php } else { ?>
							<option value="<?php echo $location['location_id']; ?>"><?php echo $location['name']. ' (' . $location['code'] . ')'; ?></option>
					<?php }
				}} ?>
				</select></td>
			</tr>]]></add>
		</operation>
    </file>
    <file name="admin/view/template/user/user_list.tpl">
		<operation>
			<search position="before"><![CDATA[<td class="left"><?php if ($sort == 'status') { ?>]]></search>
			<add><![CDATA[<td class="left"><?php if ($sort == 'location') { ?>
                <a href="<?php echo $sort_location; ?>" class="<?php echo strtolower($order); ?>"><?php echo $column_location; ?></a>
                <?php } else { ?>
                <a href="<?php echo $sort_location; ?>"><?php echo $column_location; ?></a>
                <?php } ?></td>]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[<td class="left"><?php echo $user['status']; ?></td>]]></search>
			<add><![CDATA[<td class="left"><?php echo $user['location']; ?></td>]]></add>
		</operation>
    </file>
    <file name="admin/language/english/user/user.php">
		<operation>
			<search position="before"><![CDATA[// Heading]]></search>
			<add><![CDATA[$_['entry_location']     = 'Location:';
			$_['column_location']     = 'Location';]]></add>
		</operation>
    </file>
    <file name="admin/model/user/user.php">
		<operation>
			<search position="replace"><![CDATA[$this->db->query("INSERT INTO `" . DB_PREFIX . "user` SET username = '" . $this->db->escape($data['username']) . "', salt = '" . $this->db->escape($salt = substr(md5(uniqid(rand(), true)), 0, 9)) . "', password = '" . $this->db->escape(sha1($salt . sha1($salt . sha1($data['password'])))) . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', user_group_id = '" . (int)$data['user_group_id'] . "', status = '" . (int)$data['status'] . "', date_added = NOW()");]]></search>
			<add><![CDATA[$this->db->query("INSERT INTO `" . DB_PREFIX . "user` SET username = '" . $this->db->escape($data['username']) . "', location_id = '" . (empty($data['location_id']) ? '0' : $data['location_id']) . "', salt = '" . $this->db->escape($salt = substr(md5(uniqid(rand(), true)), 0, 9)) . "', password = '" . $this->db->escape(sha1($salt . sha1($salt . sha1($data['password'])))) . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', user_group_id = '" . (int)$data['user_group_id'] . "', status = '" . (int)$data['status'] . "', date_added = NOW()");]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$this->db->query("UPDATE `" . DB_PREFIX . "user` SET username = '" . $this->db->escape($data['username']) . "', firstname = '" . $this->db->escape($data['firstname']) . "', lastname = '" . $this->db->escape($data['lastname']) . "', email = '" . $this->db->escape($data['email']) . "', user_group_id = '" . (int)$data['user_group_id'] . "', status = '" . (int)$data['status'] . "' WHERE user_id = '" . (int)$user_id . "'");]]></search>
			<add><![CDATA[if (!empty($data['location_id'])) {
			$this->db->query("UPDATE `" . DB_PREFIX . "user` SET location_id = '" . $data['location_id'] . "' WHERE user_id = '" . (int)$user_id . "'");
		}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[$sql = "SELECT * FROM `" . DB_PREFIX . "user`";]]></search>
			<add><![CDATA[$res = $this->db->query("SHOW COLUMNS FROM `". DB_PREFIX. "user` LIKE 'location_id'");
        if($res->num_rows == 0){
            $sql = "SELECT * FROM `" . DB_PREFIX . "user`";
        } else {
			$sql = "SELECT u.*, CONCAT(l.name, ' (', l.code, ')') AS location FROM `" . DB_PREFIX . "user` u LEFT JOIN `" . DB_PREFIX . "location` l ON u.location_id = l.location_id";
		}]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA['status',]]></search>
			<add><![CDATA['location',]]></add>
		</operation>
    </file>
    <file name="admin/controller/user/user.php">
		<operation>
			<search position="after"><![CDATA[$this->document->setTitle($this->language->get('heading_title'));]]></search>
			<add><![CDATA[$this->data['entry_location'] = $this->language->get('entry_location');
			$this->data['column_location'] = $this->language->get('column_location');]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA['username'   => $result['username'],]]></search>
			<add><![CDATA['location'   => empty($result['location']) ? '' : $result['location'],]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$this->data['sort_username'] = $this->url->link('user/user', 'token=' . $this->session->data['token'] . '&sort=username' . $url, 'SSL');]]></search>
			<add><![CDATA[$this->data['sort_location'] = $this->url->link('user/user', 'token=' . $this->session->data['token'] . '&sort=location' . $url, 'SSL');]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if (isset($this->request->post['status'])) {]]></search>
			<add><![CDATA[$location_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "location`");
			$this->data['locations'] = $location_query->rows;
			if (isset($this->request->post['location_id'])) {
      		$this->data['location_id'] = $this->request->post['location_id'];
    	} elseif (!empty($user_info)) {
			$this->data['location_id'] = $user_info['location_id'];
		} else {
      		$this->data['location_id'] = 1;
    	}]]></add>
		</operation>
    </file>
    <file name="admin/view/template/catalog/product_form.tpl">
		<operation>
			<search position="replace"><![CDATA[<div id="tabs" class="htabs"><a href="#tab-general"><?php echo $tab_general; ?></a><a href="#tab-data"><?php echo $tab_data; ?></a><a href="#tab-links"><?php echo $tab_links; ?></a><a href="#tab-attribute"><?php echo $tab_attribute; ?></a><a href="#tab-option"><?php echo $tab_option; ?></a><a href="#tab-discount"><?php echo $tab_discount; ?></a><a href="#tab-special"><?php echo $tab_special; ?></a><a href="#tab-image"><?php echo $tab_image; ?></a><a href="#tab-reward"><?php echo $tab_reward; ?></a><a href="#tab-design"><?php echo $tab_design; ?></a></div>]]></search>
			<add><![CDATA[<div id="tabs" class="htabs"><a href="#tab-general"><?php echo $tab_general; ?></a><a href="#tab-data"><?php echo $tab_data; ?></a><a href="#tab-links"><?php echo $tab_links; ?></a><a href="#tab-attribute"><?php echo $tab_attribute; ?></a><a href="#tab-option"><?php echo $tab_option; ?></a><a href="#tab-discount"><?php echo $tab_discount; ?></a><a href="#tab-special"><?php echo $tab_special; ?></a><a href="#tab-image"><?php echo $tab_image; ?></a><a href="#tab-reward"><?php echo $tab_reward; ?></a><a href="#tab-design"><?php echo $tab_design; ?></a><a href="#tab-location-stock"><?php echo $tab_location_stock; ?></a></div>]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[<div id="tab-option">]]></search>
			<add><![CDATA[<div id="tab-location-stock">
		  <div id="tab-location" class="htabs">
		    <?php $location_row = 0;
			  foreach ($locations as $location) { ?>
			  <a href="#tab-location-<?php echo $location_row; ?>" id="location-<?php echo $location_row; ?>"><?php echo $location['name']; ?></a>
			<?php $location_row++; } ?>
		  </div>
		  <?php $location_row = 0; ?>
		  <?php foreach ($locations as $location) { ?>
		    <div id="tab-location-<?php echo $location_row; ?>" class="tabs-content">
			  <div style="margin-bottom: 10px;">
			    <?php echo $entry_product_quantity; ?>&nbsp;
			    <input type="text" name="location_quantity[<?php echo $location['location_id']; ?>]" value="<?php echo isset($location['quantity']['product']) ? $location['quantity']['product'] : 0; ?>" />
			  </div>
			  <?php
			    $hasValidOptions = false;
				foreach ($product_options as $product_option) {
					if ($product_option['type'] == 'select' || $product_option['type'] == 'radio' || $product_option['type'] == 'checkbox' || $product_option['type'] == 'image') {
						$hasValidOptions = true;
						break;
					}
				}
			    if ($hasValidOptions) {
			  ?>
				  <div id="vtab-location-option-<?php echo $location_row; ?>" class="vtabs">
			  <?php
					$option_row = 0;
					foreach ($product_options as $product_option) {
						if ($product_option['type'] == 'select' || $product_option['type'] == 'radio' || $product_option['type'] == 'checkbox' || $product_option['type'] == 'image') {
			  ?>
			        <a href="#tab-location-<?php echo $location_row; ?>-option-<?php echo $option_row; ?>" id="location-<?php echo $location_row; ?>-option-<?php echo $option_row; ?>"><?php echo $product_option['name']; ?></a>
			  <?php
						}
						$option_row ++;
					}
			  ?>
				  </div>
			  <?php
					$option_row = 0;
					$option_value_row = 0;
					foreach ($product_options as $product_option) {
						if ($product_option['type'] == 'select' || $product_option['type'] == 'radio' || $product_option['type'] == 'checkbox' || $product_option['type'] == 'image') {
			  ?>
			      <div id="tab-location-<?php echo $location_row; ?>-option-<?php echo $option_row; ?>" class="vtabs-content">
				    <table id="location-<?php echo $location_row; ?>-option-value<?php echo $option_row; ?>" class="list" style="width: 400px;">
					  <thead>
					    <tr>
						  <td class="left"><?php echo $entry_option_value; ?></td>
						  <td class="right"><?php echo $entry_quantity; ?></td>
						</tr>
					  </thead>
					  </tbody>
			  <?php
							foreach ($product_option['product_option_value'] as $product_option_value) {
								$location_option_value_quantity = 0;
								if (isset($location['quantity']['option'][$product_option_value['product_option_value_id']])) {
									$location_option_value_quantity = $location['quantity']['option'][$product_option_value['product_option_value_id']];
								}
								$option_value_current = array();
								if (isset($option_values[$product_option['option_id']])) {
									foreach ($option_values[$product_option['option_id']] as $option_value) {
										if ($option_value['option_value_id'] == $product_option_value['option_value_id']) {
											$option_value_current = $option_value;
											break;
										}
									}
								}
								if (!empty($option_value_current)) {
			  ?>
			            <tr id="location-<?php echo $location_row; ?>-option-value-row-<?php echo $option_value_row; ?>">
						  <td class="left"><?php echo $option_value_current['name']; ?></td>
						  <td class="right"><input type="text" name="location_option_quantity[<?php echo $location['location_id']; ?>][<?php echo $product_option_value['product_option_value_id']; ?>]" value="<?php echo $location_option_value_quantity; ?>" /></td>
						</tr>
			  <?php
								}
								$option_value_row ++;
							}
			  ?>
			          </tbody>
			        </table>
				  </div>
			  <?php
						}
						$option_row ++;
					}
				}
			  ?>
			    </div>
			  <?php
				$location_row ++;
			  }
			  ?>
			</div>]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[$('#vtab-option a').tabs();]]></search>
			<add><![CDATA[$('#tab-location a').tabs();
			$('.vtabs a').tabs();]]></add>
		</operation>
    </file>
    <file name="admin/language/english/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[// Heading]]></search>
			<add><![CDATA[$_['tab_location_stock'] = 'Location Stock';
			$_['entry_product_quantity'] = 'Location Product Quantity:';]]></add>
		</operation>
    </file>
    <file name="admin/controller/catalog/product.php">
		<operation>
			<search position="after"><![CDATA[protected function getForm() {]]></search>
			<add><![CDATA[$this->data['tab_location_stock'] = $this->language->get('tab_location_stock');
			$this->data['entry_product_quantity'] = $this->language->get('entry_product_quantity');]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[$this->template = 'catalog/product_form.tpl';]]></search>
			<add><![CDATA[if (isset($this->request->get['product_id'])) {
			$this->data['locations'] = $this->model_catalog_product->getLocations($this->request->get['product_id']);
		} else {
			$this->data['locations'] = array();
		}]]></add>
		</operation>
	</file>
    <file name="admin/model/catalog/product.php">
		<operation>
			<search position="before"><![CDATA[public function addProduct($data) {]]></search>
			<add><![CDATA[public function getLocations($product_id) {
				$location_query = $this->db->query("SELECT * FROM `" . DB_PREFIX . "location`");
				$locations = $location_query->rows;
				if (!empty($locations)) {
					foreach ($locations as $key => $location) {
						$location_stocks_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . $location['location_id'] . "' AND product_id = '" . $product_id . "'");
						$option_stock = array();
						if (!empty($location_stocks_query->rows)) {
							foreach ($location_stocks_query->rows as $location_stock) {
								if (isset($location_stock['product_option_value_id']) && ((int)$location_stock['product_option_value_id']) > 0) {
									$option_stock[(int)$location_stock['product_option_value_id']] = $location_stock['quantity'];
								} else {
									$locations[$key]['quantity']['product'] = $location_stock['quantity'];
								}
							}
						}
						$locations[$key]['quantity']['option'] = $option_stock;
					}
				}
				
				return $locations;
			}]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[if (isset($data['image'])) {]]></search>
			<add><![CDATA[if (!empty($data['location_quantity'])) {
				foreach ($data['location_quantity'] as $location_id => $location_quantity) {
					$product_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . (int)$location_id . "' AND product_id = '" . (int)$product_id . "' AND product_option_value_id = '0'");
					if ($product_query->row) {
						$this->db->query("UPDATE " . DB_PREFIX . "location_stock SET quantity = '" . (int)$location_quantity . "' WHERE location_stock_id = '" . $product_query->row['location_stock_id'] . "'");
					} else {
						$this->db->query("INSERT INTO " . DB_PREFIX . "location_stock SET quantity = '" . (int)$location_quantity . "', location_id = '" . (int)$location_id . "', product_id = '" . (int)$product_id . "', product_option_value_id = '0'");
					}
				}
			}
			if (!empty($data['location_option_quantity'])) {
				foreach ($data['location_option_quantity'] as $location_id => $location_option_quantity) {
					foreach ($location_option_quantity as $product_option_value_id => $product_option_quantity) {
						$option_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . (int)$location_id . "' AND product_id = '" . (int)$product_id . "' AND product_option_value_id = '" . (int)$product_option_value_id . "'");
						if ($option_query->row) {
							$this->db->query("UPDATE " . DB_PREFIX . "location_stock SET quantity = '" . (int)$product_option_quantity . "' WHERE location_stock_id = '" . $option_query->row['location_stock_id'] . "'");
						} else {
							$this->db->query("INSERT INTO " . DB_PREFIX . "location_stock SET quantity = '" . (int)$product_option_quantity . "', location_id = '" . (int)$location_id . "', product_id = '" . (int)$product_id . "', product_option_value_id = '" . (int)$product_option_value_id . "'");
						}
					}
				}
			}]]></add>
		</operation>
    </file>
    <file name="system/library/cart.php">
		<operation>
			<search position="replace" index="1"><![CDATA[if ($option_value_query->row['subtract'] && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $quantity))) {]]></search>
			<add><![CDATA[$has_stock = true;
			if ($this->config->get('enable_location_stock') && isset($this->session->data['location_id']) && $this->session->data['location_id']) {
				$location_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . (int)$this->session->data['location_id'] . "' AND product_option_value_id = '" . (int)$option_value . "'");
				if ($location_query->row && (!$location_query->row['quantity'] || $location_query->row['quantity'] < $quantity)) {
					$has_stock = false;
				}
			} else {
				if ($option_value_query->row['subtract'] && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $quantity))) {
					$has_stock = false;
				}
			}
			if (!$has_stock) {]]></add>
		</operation>
		<operation>
			<search position="replace" index="2"><![CDATA[if ($option_value_query->row['subtract'] && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $quantity))) {]]></search>
			<add><![CDATA[$has_stock = true;
			if ($this->config->get('enable_location_stock') && isset($this->session->data['location_id']) && $this->session->data['location_id']) {
				$location_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . (int)$this->session->data['location_id'] . "' AND product_option_value_id = '" . (int)$product_option_value_id . "'");
				if ($location_query->row && (!$location_query->row['quantity'] || $location_query->row['quantity'] < $quantity)) {
					$has_stock = false;
				}
			} else {
				if ($option_value_query->row['subtract'] && (!$option_value_query->row['quantity'] || ($option_value_query->row['quantity'] < $quantity))) {
					$has_stock = false;
				}
			}
			if (!$has_stock) {]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[if (!$product_query->row['quantity'] || ($product_query->row['quantity'] < $quantity)) {]]></search>
			<add><![CDATA[$has_stock = true;
			if ($this->config->get('enable_location_stock') && isset($this->session->data['location_id']) && $this->session->data['location_id']) {
				$location_query = $this->db->query("SELECT * FROM " . DB_PREFIX . "location_stock WHERE location_id = '" . (int)$this->session->data['location_id'] . "' AND product_id = '" . (int)$product_query->row['product_id'] . "' AND product_option_value_id = '0'");
				if ($location_query->row && (!$location_query->row['quantity'] || $location_query->row['quantity'] < $quantity)) {
					$has_stock = false;
				}
			} else {
				if (!$product_query->row['quantity'] || ($product_query->row['quantity'] < $quantity)) {
					$has_stock = false;
				}
			}
			if (!$has_stock) {]]></add>
		</operation>
	</file>
</modification>